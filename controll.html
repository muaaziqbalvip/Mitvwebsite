<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiTV Pro | Digital Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-purple: #bc13fe;
            --neon-green: #39ff14;
            --dark-bg: #010409;
            --card-bg: rgba(13, 17, 23, 0.9);
            --border-glow: rgba(0, 242, 255, 0.3);
        }

        body {
            background-color: var(--dark-bg);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 242, 255, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(188, 19, 254, 0.05) 0%, transparent 20%);
            color: #e2e8f0;
            font-family: 'Rajdhani', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }
        .mono { font-family: 'Source Code Pro', monospace; }

        /* Futuristic Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #010409; }
        ::-webkit-scrollbar-thumb { background: var(--neon-blue); border-radius: 10px; }

        /* Cyberpunk Borders */
        .cyber-border {
            border: 1px solid var(--border-glow);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5), inset 0 0 10px rgba(0, 242, 255, 0.05);
            backdrop-filter: blur(10px);
        }

        .neon-text-blue { text-shadow: 0 0 10px var(--neon-blue); color: var(--neon-blue); }
        .neon-text-green { text-shadow: 0 0 10px var(--neon-green); color: var(--neon-green); }

        /* Animated Background Gradients */
        .bg-animate {
            background: linear-gradient(-45deg, #0d1117, #161b22, #010409, #0d1117);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 12px;
            border-radius: 6px;
            width: 100%;
            transition: all 0.3s;
        }

        .glass-input:focus {
            border-color: var(--neon-blue);
            box-shadow: 0 0 10px var(--border-glow);
            outline: none;
        }

        .nav-btn {
            position: relative;
            overflow: hidden;
            transition: 0.4s;
        }

        .nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 242, 255, 0.2);
        }

        .hidden { display: none !important; }

        /* Table Styling */
        table { border-collapse: separate; border-spacing: 0 8px; }
        tr { transition: 0.3s; }
        tr:hover { background: rgba(255, 255, 255, 0.03); }

        .loading-bar {
            height: 2px;
            background: var(--neon-blue);
            width: 0%;
            box-shadow: 0 0 10px var(--neon-blue);
            transition: width 0.4s;
        }
    </style>
</head>
<body class="bg-animate">

    <div id="top-loader" class="fixed top-0 left-0 z-[3000] loading-bar"></div>

    <div id="lock-screen" class="fixed inset-0 z-[2500] bg-black flex items-center justify-center p-6">
        <div class="cyber-border p-12 rounded-3xl w-full max-w-lg bg-black/80 text-center relative overflow-hidden">
            <div class="absolute -top-24 -left-24 w-48 h-48 bg-cyan-500/10 blur-3xl rounded-full"></div>
            <h1 class="text-5xl font-bold orbitron neon-text-blue mb-2 italic">MiTV <span class="text-white">PRO</span></h1>
            <p class="text-xs tracking-[0.5em] text-gray-500 mb-10 uppercase">Security Protocol Alpha-9</p>
            
            <div class="relative mb-6">
                <i class="fas fa-fingerprint absolute left-4 top-1/2 -translate-y-1/2 text-cyan-500"></i>
                <input type="password" id="pass-input" placeholder="ACCESS ENCRYPTION KEY" class="glass-input pl-12 text-center tracking-[1em] font-bold">
            </div>
            
            <button onclick="attemptLogin()" class="w-full py-4 rounded-lg bg-gradient-to-r from-cyan-600 to-blue-700 font-bold orbitron tracking-widest hover:brightness-125 transition active:scale-95">
                AUTHORIZE ACCESS
            </button>
            <p id="login-err" class="text-red-500 text-[10px] mt-4 hidden uppercase tracking-widest">Access Denied: Invalid Authentication</p>
        </div>
    </div>

    <div id="main-ui" class="hidden min-h-screen flex flex-col">
        
        <header class="cyber-border sticky top-0 z-[1000] bg-black/80 backdrop-blur-xl border-x-0 border-t-0 p-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-cyan-500 rounded-lg flex items-center justify-center shadow-[0_0_15px_rgba(6,182,212,0.5)]">
                        <i class="fas fa-shield-alt text-black"></i>
                    </div>
                    <div>
                        <h2 class="orbitron text-sm font-bold tracking-tighter">MASTER COMMAND</h2>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                            <span class="text-[9px] text-gray-400 mono uppercase" id="current-session-time">System Active</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-4">
                    <button onclick="location.reload()" class="px-4 py-2 bg-red-500/10 border border-red-500/30 text-red-500 rounded text-[10px] font-bold orbitron hover:bg-red-500 hover:text-white transition">
                        TERMINATE SESSION
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 max-w-7xl mx-auto w-full p-4 md:p-8">
            
            <div id="stats-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="cyber-border p-4 rounded-xl bg-cyan-500/5">
                    <p class="text-[10px] text-gray-400 uppercase">Total Clients</p>
                    <h3 class="text-2xl font-bold orbitron" id="stat-total-users">0</h3>
                </div>
                <div class="cyber-border p-4 rounded-xl bg-green-500/5">
                    <p class="text-[10px] text-gray-400 uppercase">Active Links</p>
                    <h3 class="text-2xl font-bold orbitron text-green-400" id="stat-active-links">0</h3>
                </div>
                <div class="cyber-border p-4 rounded-xl bg-purple-500/5">
                    <p class="text-[10px] text-gray-400 uppercase">Streams Managed</p>
                    <h3 class="text-2xl font-bold orbitron text-purple-400">3 Base</h3>
                </div>
                <div class="cyber-border p-4 rounded-xl bg-orange-500/5">
                    <p class="text-[10px] text-gray-400 uppercase">System Status</p>
                    <h3 class="text-2xl font-bold orbitron text-orange-400">Secure</h3>
                </div>
            </div>

            <div id="main-nav" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                <div onclick="showView('add-client-view')" class="cyber-border p-8 rounded-2xl cursor-pointer bg-cyan-900/10 group hover:border-cyan-500 transition">
                    <div class="w-14 h-14 bg-cyan-500/20 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition">
                        <i class="fas fa-plus text-2xl text-cyan-400"></i>
                    </div>
                    <h4 class="orbitron text-lg font-bold">REGISTRATION</h4>
                    <p class="text-xs text-gray-500">Add new customers with mitv tag.</p>
                </div>
                
                <div onclick="loadRedirectDatabase()" class="cyber-border p-8 rounded-2xl cursor-pointer bg-green-900/10 group hover:border-green-500 transition">
                    <div class="w-14 h-14 bg-green-500/20 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition">
                        <i class="fas fa-server text-2xl text-green-400"></i>
                    </div>
                    <h4 class="orbitron text-lg font-bold">CLIENT DATABASE</h4>
                    <p class="text-xs text-gray-500">Manage redirects, block users, and edit plans.</p>
                </div>

                <div onclick="showView('stream-engine-view')" class="cyber-border p-8 rounded-2xl cursor-pointer bg-purple-900/10 group hover:border-purple-500 transition">
                    <div class="w-14 h-14 bg-purple-500/20 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition">
                        <i class="fas fa-broadcast-tower text-2xl text-purple-400"></i>
                    </div>
                    <h4 class="orbitron text-lg font-bold">STREAM ENGINE</h4>
                    <p class="text-xs text-gray-500">Edit M3U files, channels, logos, and categories.</p>
                </div>
            </div>

            <section id="add-client-view" class="hidden">
                <div class="max-w-3xl mx-auto cyber-border p-8 rounded-3xl bg-black/60">
                    <div class="flex items-center gap-4 mb-8">
                        <button onclick="showView('main-nav')" class="text-gray-500 hover:text-white transition"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="orbitron text-xl font-bold neon-text-blue uppercase tracking-widest">New Deployment</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-[10px] uppercase font-bold text-gray-400 mono">Client Identity (No Spaces)</label>
                            <input type="text" id="reg-name" placeholder="e.g. imran_khan" class="glass-input">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] uppercase font-bold text-gray-400 mono">Unique Access ID / Phone</label>
                            <input type="number" id="reg-id" placeholder="e.g. 03001234567" class="glass-input">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] uppercase font-bold text-gray-400 mono">Assigned Package</label>
                            <select id="reg-pkg" class="glass-input">
                                <option value="pk150.m3u">MiTV Basic (150)</option>
                                <option value="pkmitv.m3u">MiTV Standard (200)</option>
                                <option value="mitv450.m3u">MiTV Premium (450)</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] uppercase font-bold text-gray-400 mono">Subscription Cycle</label>
                            <select id="reg-duration" class="glass-input">
                                <option value="1">1 Month</option>
                                <option value="3">3 Months</option>
                                <option value="6">6 Months</option>
                                <option value="12">1 Year</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] uppercase font-bold text-gray-400 mono">Referral Agent</label>
                            <input type="text" id="reg-ref" placeholder="Agent Name" class="glass-input">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] uppercase font-bold text-gray-400 mono">Payment Status (PKR)</label>
                            <input type="number" id="reg-price" placeholder="Amount" class="glass-input">
                        </div>
                    </div>

                    <button onclick="initiateClientSync()" id="btn-sync-client" class="w-full mt-10 py-5 rounded-xl bg-cyan-600 font-bold orbitron tracking-[0.3em] hover:bg-cyan-500 shadow-lg shadow-cyan-500/20 active:scale-95 transition">
                        INITIALIZE SYNC WITH MITV TAG
                    </button>
                </div>
            </section>

            <section id="database-view" class="hidden">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
                    <div class="flex items-center gap-4">
                        <button onclick="showView('main-nav')" class="text-gray-500 hover:text-white transition"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="orbitron text-xl font-bold text-green-400 uppercase tracking-widest italic">Encrypted Database</h2>
                    </div>
                    <div class="relative w-full md:w-96">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                        <input type="text" id="db-search" onkeyup="filterDatabase()" placeholder="SEARCH BY NAME OR ID..." class="glass-input pl-12 text-xs">
                    </div>
                </div>

                <div class="cyber-border rounded-2xl bg-black/40 overflow-hidden">
                    <table class="w-full text-xs">
                        <thead>
                            <tr class="bg-white/5 text-gray-400 uppercase orbitron tracking-tighter">
                                <th class="p-5 text-left">Deployment Date</th>
                                <th class="p-5 text-left">Identity</th>
                                <th class="p-5 text-left">Stream Route</th>
                                <th class="p-5 text-left">Referral</th>
                                <th class="p-5 text-center">Protocol</th>
                                <th class="p-5 text-right">System Action</th>
                            </tr>
                        </thead>
                        <tbody id="db-tbody" class="divide-y divide-white/5">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="stream-engine-view" class="hidden">
                <div class="cyber-border p-6 rounded-2xl bg-black/60 mb-8 flex flex-wrap items-center gap-6">
                    <button onclick="showView('main-nav')" class="text-gray-500"><i class="fas fa-arrow-left"></i></button>
                    <div class="flex-1">
                        <label class="text-[9px] uppercase font-bold text-cyan-400 mono block mb-2">Primary Stream Selector</label>
                        <select id="m3u-selector" onchange="fetchM3UData()" class="glass-input !py-2 border-cyan-500/20">
                            <option value="">-- CHOOSE SOURCE --</option>
                            <option value="pk150.m3u">MiTV Basic Core (150)</option>
                            <option value="pkmitv.m3u">MiTV Standard Core (200)</option>
                            <option value="mitv450.m3u">MiTV Ultra Core (450)</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openChannelEditor(-1)" class="px-6 py-2 bg-cyan-600 rounded-lg text-[10px] font-bold orbitron uppercase">Add Channel</button>
                        <button onclick="saveM3UToGitHub()" class="px-6 py-2 bg-green-600 rounded-lg text-[10px] font-bold orbitron uppercase">Push to Cloud</button>
                    </div>
                </div>

                <div id="m3u-category-grid" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>

                <div id="m3u-channel-view" class="hidden">
                    <div class="flex items-center justify-between mb-6">
                        <button onclick="renderM3UCategories()" class="text-purple-400 text-xs font-bold uppercase"><i class="fas fa-chevron-left mr-2"></i> Categories</button>
                        <h3 id="current-category-name" class="orbitron font-bold text-lg text-white"></h3>
                    </div>
                    <div id="channel-list-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
            </section>

        </main>
    </div>

    <div id="editor-modal" class="hidden fixed inset-0 z-[2000] bg-black/90 flex items-center justify-center p-4">
        <div class="cyber-border p-8 rounded-3xl w-full max-w-xl bg-gray-900 shadow-2xl">
            <h3 class="orbitron text-xl font-bold text-cyan-400 mb-6 uppercase tracking-widest">Signal configuration</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[9px] uppercase font-bold text-gray-500">Channel Name</label>
                    <input type="text" id="ed-name" class="glass-input">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] uppercase font-bold text-gray-500">Group / Category</label>
                    <input type="text" id="ed-group" class="glass-input">
                </div>
                <div class="col-span-full space-y-1">
                    <label class="text-[9px] uppercase font-bold text-gray-500">Logo Endpoint (URL)</label>
                    <input type="text" id="ed-logo" class="glass-input">
                </div>
                <div class="col-span-full space-y-1">
                    <label class="text-[9px] uppercase font-bold text-gray-500">Source Link (HLS/M3U8)</label>
                    <input type="text" id="ed-link" class="glass-input">
                </div>
            </div>
            <div class="flex gap-4 mt-8">
                <button onclick="commitChannelChange()" class="flex-1 py-4 bg-cyan-600 rounded-xl orbitron font-bold">SAVE SIGNAL</button>
                <button onclick="closeModal()" class="flex-1 py-4 bg-white/5 border border-white/10 rounded-xl orbitron font-bold">CANCEL</button>
            </div>
        </div>
    </div>

    <script>
        // --- CORE SYSTEM CONFIGURATION ---
        const SYS_CONFIG = {
            TOKEN: "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",
            CLIENT_REPO: "muaaziqbalvip/Mitvstream",
            STREAM_REPO: "muaaziqbalvip/Mitvstream",
            BASE_STREAM_URL: "https://mitvstream.netlify.app/",
            ACCESS_KEY: "mu@@z1972"
        };

        let db_redirects = [];
        let db_users = [];
        let m3u_collection = [];
        let current_m3u_sha = "";
        let current_m3u_file = "";
        let edit_index = -1;

        // --- AUTHENTICATION ---
        function attemptLogin() {
            const input = document.getElementById('pass-input').value;
            if(input === SYS_CONFIG.ACCESS_KEY) {
                document.getElementById('lock-screen').classList.add('hidden');
                document.getElementById('main-ui').classList.remove('hidden');
                updateClock();
            } else {
                const err = document.getElementById('login-err');
                err.classList.remove('hidden');
                setTimeout(() => err.classList.add('hidden'), 2000);
            }
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('current-session-time').innerText = `Sync: ${now.toLocaleTimeString()} | 2026 Ready`;
        }

        // --- GITHUB API BRIDGE ---
        async function callGitHub(repo, path, method = 'GET', body = null) {
            startLoader();
            const url = `https://api.github.com/repos/${repo}/contents/${path}?t=${Date.now()}`;
            const options = {
                method,
                headers: {
                    'Authorization': `token ${SYS_CONFIG.TOKEN}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: body ? JSON.stringify(body) : null
            };

            const response = await fetch(url, options);
            const data = await response.json();
            stopLoader();

            if (!response.ok) throw new Error(data.message);
            return data;
        }

        function startLoader() { document.getElementById('top-loader').style.width = '70%'; }
        function stopLoader() { 
            document.getElementById('top-loader').style.width = '100%';
            setTimeout(() => document.getElementById('top-loader').style.width = '0%', 400);
        }

        const b64U = (s) => btoa(unescape(encodeURIComponent(s.trim())));
        const uB64 = (s) => decodeURIComponent(escape(atob(s)));

        // --- NAVIGATION ---
        function showView(viewId) {
            const views = ['main-nav', 'add-client-view', 'database-view', 'stream-engine-view'];
            views.forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        // --- UPDATED REGISTRATION LOGIC ---
        async function initiateClientSync() {
            const name = document.getElementById('reg-name').value.trim().replace(/\s+/g, '_');
            const id = document.getElementById('reg-id').value.trim();
            const pkg = document.getElementById('reg-pkg').value;
            const duration = document.getElementById('reg-duration').value;
            const ref = document.getElementById('reg-ref').value || "DIRECT_DEAL";
            const cash = document.getElementById('reg-price').value || "0";

            if(!name || !id) return alert("CRITICAL: IDENTITY MISSING");

            try {
                // 1. Fetch current _redirects
                const redFile = await callGitHub(SYS_CONFIG.CLIENT_REPO, '_redirects');
                const redContent = uB64(redFile.content);
                
                // 2. Generate Redirect Line using 'mitv' tag
                const redirectLine = `/${name}/mitv.m3u* ${SYS_CONFIG.BASE_STREAM_URL}${pkg} 200`;
                const updatedRed = redContent + "\n" + redirectLine;

                // 3. Update _redirects
                await callGitHub(SYS_CONFIG.CLIENT_REPO, '_redirects', 'PUT', {
                    message: `System: Deploy Client ${name} with mitv tag`,
                    content: b64U(updatedRed),
                    sha: redFile.sha
                });

                // 4. Update user.csv (Keeps original ID for records)
                const csvFile = await callGitHub(SYS_CONFIG.CLIENT_REPO, 'user.csv');
                const csvContent = uB64(csvFile.content);
                const expiry = new Date();
                expiry.setMonth(expiry.getMonth() + parseInt(duration));
                
                const newRow = `\n${new Date().toLocaleDateString()},${name},${id},${pkg},${expiry.toLocaleDateString()},${ref},${cash}`;
                await callGitHub(SYS_CONFIG.CLIENT_REPO, 'user.csv', 'PUT', {
                    message: `System: Log Transaction ${name}`,
                    content: b64U(csvContent + newRow),
                    sha: csvFile.sha
                });

                alert(`DEPLOYMENT SUCCESSFUL\nClient Link: /${name}/mitv.m3u`);
                location.reload();
            } catch(e) { alert("SYNC FAILED: " + e.message); }
        }

        // --- DATABASE MANAGEMENT ---
        async function loadRedirectDatabase() {
            showView('database-view');
            const tbody = document.getElementById('db-tbody');
            tbody.innerHTML = `<tr><td colspan="6" class="p-20 text-center orbitron text-cyan-500 animate-pulse">Scanning Decrypted Layers...</td></tr>`;

            try {
                const redFile = await callGitHub(SYS_CONFIG.CLIENT_REPO, '_redirects');
                const lines = uB64(redFile.content).split('\n');
                tbody.innerHTML = "";
                let activeCount = 0;

                lines.forEach((line, idx) => {
                    if(!line.trim() || (line.startsWith('#') && !line.startsWith('##'))) return;

                    const isBlocked = line.trim().startsWith('##');
                    const clean = line.replace('##', '').trim();
                    const parts = clean.split(' ');
                    
                    const clientPath = parts[0] || "ERR";
                    const targetPkg = parts[1] ? parts[1].split('/').pop() : "ERR";

                    activeCount += isBlocked ? 0 : 1;

                    tbody.innerHTML += `
                        <tr class="db-row" data-name="${clientPath}">
                            <td class="p-5 mono text-gray-500 text-[10px]">LOCKED</td>
                            <td class="p-5 font-bold text-white uppercase tracking-wider">${clientPath}</td>
                            <td class="p-5"><span class="px-2 py-1 bg-white/5 rounded text-cyan-400 font-bold">${targetPkg}</span></td>
                            <td class="p-5 text-gray-400">ENCRYPTED</td>
                            <td class="p-5 text-center">
                                <span class="${isBlocked?'text-red-500':'text-green-500'} font-bold orbitron text-[9px] border ${isBlocked?'border-red-500/30':'border-green-500/30'} px-3 py-1 rounded-full bg-black">
                                    ${isBlocked ? 'BLOCKED' : 'ACTIVE'}
                                </span>
                            </td>
                            <td class="p-5 text-right">
                                <div class="flex justify-end gap-2">
                                    <button onclick="toggleClientProtocol(${idx}, ${isBlocked})" class="p-2 bg-white/5 rounded hover:bg-white/10" title="Toggle Block">
                                        <i class="fas ${isBlocked?'fa-play text-green-500':'fa-pause text-orange-500'}"></i>
                                    </button>
                                    <button onclick="editClientStream(${idx})" class="p-2 bg-white/5 rounded hover:bg-white/10" title="Edit Package">
                                        <i class="fas fa-edit text-cyan-500"></i>
                                    </button>
                                    <button onclick="nukeClient(${idx})" class="p-2 bg-red-500/10 rounded hover:bg-red-500/20" title="Delete Permanent">
                                        <i class="fas fa-trash-alt text-red-500"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                document.getElementById('stat-total-users').innerText = lines.filter(l => l.trim() && !l.startsWith('#')).length;
                document.getElementById('stat-active-links').innerText = activeCount;

            } catch(e) { tbody.innerHTML = `<tr><td colspan="6" class="text-center p-10 text-red-500">DATABASE OFFLINE</td></tr>`; }
        }

        async function toggleClientProtocol(idx, currentlyBlocked) {
            const redFile = await callGitHub(SYS_CONFIG.CLIENT_REPO, '_redirects');
            let lines = uB64(redFile.content).split('\n');
            let line = lines[idx].trim();

            lines[idx] = currentlyBlocked ? line.replace('##', '') : '##' + line;

            await callGitHub(SYS_CONFIG.CLIENT_REPO, '_redirects', 'PUT', {
                message: "System: Protocol Toggle",
                content: b64U(lines.join('\n')),
                sha: redFile.sha
            });
            loadRedirectDatabase();
        }

        async function editClientStream(idx) {
            const newPkg = prompt("Enter Target Package Name (e.g. mitv450.m3u):");
            if(!newPkg) return;

            const redFile = await callGitHub(SYS_CONFIG.CLIENT_REPO, '_redirects');
            let lines = uB64(redFile.content).split('\n');
            let parts = lines[idx].split(' ');
            
            parts[1] = `${SYS_CONFIG.BASE_STREAM_URL}${newPkg}`;
            lines[idx] = parts.join(' ');

            await callGitHub(SYS_CONFIG.CLIENT_REPO, '_redirects', 'PUT', {
                message: "System: Route Updated",
                content: b64U(lines.join('\n')),
                sha: redFile.sha
            });
            loadRedirectDatabase();
        }

        async function nukeClient(idx) {
            if(!confirm("PERMANENTLY DELETE THIS DEPLOYMENT?")) return;
            const redFile = await callGitHub(SYS_CONFIG.CLIENT_REPO, '_redirects');
            let lines = uB64(redFile.content).split('\n');
            lines.splice(idx, 1);
            await callGitHub(SYS_CONFIG.CLIENT_REPO, '_redirects', 'PUT', {
                message: "System: Client Purged",
                content: b64U(lines.join('\n')),
                sha: redFile.sha
            });
            loadRedirectDatabase();
        }

        function filterDatabase() {
            const query = document.getElementById('db-search').value.toLowerCase();
            document.querySelectorAll('.db-row').forEach(row => {
                row.style.display = row.getAttribute('data-name').toLowerCase().includes(query) ? '' : 'none';
            });
        }

        // --- STREAM ENGINE LOGIC ---
        async function fetchM3UData() {
            current_m3u_file = document.getElementById('m3u-selector').value;
            if(!current_m3u_file) return;

            try {
                const file = await callGitHub(SYS_CONFIG.STREAM_REPO, current_m3u_file);
                current_m3u_sha = file.sha;
                const content = uB64(file.content);
                
                parseM3U(content);
                renderM3UCategories();
            } catch(e) { alert("SOURCE FETCH ERROR"); }
        }

        function parseM3U(content) {
            const lines = content.split('\n');
            m3u_collection = [];
            let currentObj = null;

            lines.forEach(line => {
                if(line.includes('#EXTINF:')) {
                    currentObj = {
                        name: line.split(',')[1]?.trim() || "Untitled Channel",
                        logo: line.match(/tvg-logo="([^"]*)"/)?.[1] || "",
                        group: line.match(/group-title="([^"]*)"/)?.[1] || "GENERAL",
                        link: "",
                        hidden: line.trim().startsWith('##')
                    };
                    m3u_collection.push(currentObj);
                } else if(line.startsWith('http') && currentObj) {
                    currentObj.link = line.trim();
                    currentObj = null;
                }
            });
        }

        function renderM3UCategories() {
            const grid = document.getElementById('m3u-category-grid');
            document.getElementById('m3u-channel-view').classList.add('hidden');
            grid.classList.remove('hidden');
            grid.innerHTML = "";

            const categories = [...new Set(m3u_collection.map(c => c.group))];
            
            categories.forEach(cat => {
                const count = m3u_collection.filter(c => c.group === cat).length;
                grid.innerHTML += `
                    <div onclick="renderChannelsInCategory('${cat}')" class="cyber-border p-6 rounded-xl text-center cursor-pointer hover:bg-purple-500/10 transition group">
                        <i class="fas fa-folder text-purple-500 mb-3 text-2xl group-hover:scale-110 transition"></i>
                        <h5 class="orbitron text-[10px] font-bold text-white mb-1 uppercase">${cat}</h5>
                        <p class="text-[9px] text-gray-500 mono">${count} Signals</p>
                    </div>
                `;
            });
        }

        function renderChannelsInCategory(category) {
            document.getElementById('m3u-category-grid').classList.add('hidden');
            const view = document.getElementById('m3u-channel-view');
            view.classList.remove('hidden');
            document.getElementById('current-category-name').innerText = category;

            const grid = document.getElementById('channel-list-grid');
            grid.innerHTML = "";

            m3u_collection.forEach((ch, idx) => {
                if(ch.group === category) {
                    grid.innerHTML += `
                        <div class="cyber-border p-4 rounded-xl bg-black/40 flex items-center gap-4 ${ch.hidden?'opacity-30':''}">
                            <img src="${ch.logo}" class="w-12 h-12 object-contain bg-black rounded p-1 border border-white/5" onerror="this.src='https://placehold.co/100x100?text=MiTV'">
                            <div class="flex-1 min-w-0">
                                <p class="text-xs font-bold text-white truncate uppercase">${ch.name}</p>
                                <p class="text-[8px] text-gray-500 mono truncate">${ch.link}</p>
                            </div>
                            <div class="flex flex-col gap-2">
                                <button onclick="openChannelEditor(${idx})" class="text-cyan-400 hover:scale-110 transition"><i class="fas fa-cog"></i></button>
                                <button onclick="toggleChannelVisibility(${idx}, '${category}')" class="text-white hover:scale-110 transition"><i class="fas ${ch.hidden?'fa-eye-slash text-red-500':'fa-eye text-green-500'}"></i></button>
                            </div>
                        </div>
                    `;
                }
            });
        }

        function toggleChannelVisibility(idx, cat) {
            m3u_collection[idx].hidden = !m3u_collection[idx].hidden;
            renderChannelsInCategory(cat);
        }

        function openChannelEditor(idx) {
            edit_index = idx;
            if(idx === -1) {
                document.getElementById('ed-name').value = "";
                document.getElementById('ed-logo').value = "";
                document.getElementById('ed-group').value = "GENERAL";
                document.getElementById('ed-link').value = "";
            } else {
                const ch = m3u_collection[idx];
                document.getElementById('ed-name').value = ch.name;
                document.getElementById('ed-logo').value = ch.logo;
                document.getElementById('ed-group').value = ch.group;
                document.getElementById('ed-link').value = ch.link;
            }
            document.getElementById('editor-modal').classList.remove('hidden');
        }

        function commitChannelChange() {
            const ch = {
                name: document.getElementById('ed-name').value,
                logo: document.getElementById('ed-logo').value,
                group: document.getElementById('ed-group').value,
                link: document.getElementById('ed-link').value,
                hidden: false
            };

            if(edit_index === -1) m3u_collection.push(ch);
            else m3u_collection[edit_index] = ch;

            closeModal();
            renderM3UCategories();
        }

        async function saveM3UToGitHub() {
            let content = "#EXTM3U\n";
            m3u_collection.forEach(ch => {
                content += `${ch.hidden?'##':'#'}EXTINF:-1 tvg-logo="${ch.logo}" group-title="${ch.group}\",${ch.name}\n${ch.link}\n`;
            });

            try {
                await callGitHub(SYS_CONFIG.STREAM_REPO, current_m3u_file, 'PUT', {
                    message: "Engine: Signal Optimization",
                    content: b64U(content),
                    sha: current_m3u_sha
                });
                alert("CLOUD SYNC COMPLETE");
                fetchM3UData();
            } catch(e) { alert("CLOUD SYNC FAILED"); }
        }

        function closeModal() { document.getElementById('editor-modal').classList.add('hidden'); }
    </script>
</body>
</html>
