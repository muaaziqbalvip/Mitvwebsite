<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiTV Pro | Final Stable Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --neon: #00f2ff; --bg: #010409; }
        body { background: var(--bg); color: #e2e8f0; font-family: 'Rajdhani', sans-serif; }
        .cyber-card { background: rgba(13, 17, 23, 0.9); border: 1px solid rgba(0, 242, 255, 0.1); box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        .glass-input { background: #0d1117; border: 1px solid #30363d; color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; transition: 0.3s; }
        .glass-input:focus { border-color: var(--neon); }
        .hidden { display: none !important; }
        .channel-tile { background: #0d1117; border: 1px solid #21262d; border-radius: 15px; transition: 0.3s; }
        .channel-tile:hover { border-color: var(--neon); transform: translateY(-3px); }
    </style>
</head>
<body>

    <div id="lock-screen" class="fixed inset-0 z-[1000] bg-[#010409] flex items-center justify-center p-4">
        <div class="cyber-card p-10 rounded-3xl w-full max-w-md text-center border-t-4 border-t-cyan-500">
            <h1 class="text-3xl font-bold font-['Orbitron'] text-white mb-2">MiTV <span class="text-cyan-400">PRO</span></h1>
            <p class="text-[10px] text-gray-500 tracking-[5px] mb-8 uppercase">Security Protocol v6.1</p>
            <input type="password" id="pass-input" placeholder="ENTER ACCESS CODE" class="glass-input text-center mb-4 tracking-widest font-bold">
            <button onclick="checkLogin()" class="w-full bg-cyan-600 py-4 rounded-xl font-bold hover:bg-cyan-500 transition shadow-lg shadow-cyan-900/20">UNSEAL PANEL</button>
            <p id="err-msg" class="text-red-500 text-xs mt-4 hidden">INVALID CODE - ACCESS DENIED</p>
        </div>
    </div>

    <div id="dashboard-ui" class="hidden min-h-screen">
        <header class="p-4 border-b border-white/5 flex justify-between items-center bg-black/40 backdrop-blur-md sticky top-0 z-50">
            <div class="flex items-center gap-3">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-ping"></div>
                <h2 class="font-bold font-['Orbitron'] text-sm tracking-tighter text-white">ID: <span id="display-user" class="text-cyan-400"></span></h2>
            </div>
            <button onclick="location.reload()" class="text-[10px] bg-red-900/20 text-red-400 px-4 py-1.5 rounded-full border border-red-500/20 font-bold uppercase">Logout</button>
        </header>

        <main class="max-w-7xl mx-auto p-4 md:p-6">
            
            <div id="stats-area" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="cyber-card p-4 rounded-2xl text-center">
                    <p class="text-[10px] text-gray-500 uppercase">Referrals</p>
                    <h3 id="stat-count" class="text-2xl font-bold text-white">0</h3>
                </div>
                <div class="cyber-card p-4 rounded-2xl text-center">
                    <p class="text-[10px] text-gray-500 uppercase">Monthly Cash</p>
                    <h3 id="stat-cash" class="text-2xl font-bold text-green-400">Rs. 0</h3>
                </div>
            </div>

            <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-10">
                <button onclick="openPage('add-user-page')" class="cyber-card p-8 rounded-2xl text-center hover:bg-cyan-500/5 transition">
                    <i class="fas fa-plus-circle text-3xl text-cyan-400 mb-2"></i>
                    <h3 class="font-bold text-sm">ADD NEW USER</h3>
                </button>
                <button onclick="loadRedirectList()" class="cyber-card p-8 rounded-2xl text-center hover:bg-green-500/5 transition">
                    <i class="fas fa-users-cog text-3xl text-green-400 mb-2"></i>
                    <h3 class="font-bold text-sm">MANAGE CONNECTIONS</h3>
                </button>
                <button id="admin-m3u-btn" onclick="openPage('m3u-editor-page')" class="cyber-card p-8 rounded-2xl text-center hover:bg-purple-500/5 transition">
                    <i class="fas fa-tv text-3xl text-purple-400 mb-2"></i>
                    <h3 class="font-bold text-sm">M3U CHANNEL ENGINE</h3>
                </button>
            </div>

            <section id="add-user-page" class="hidden max-w-xl mx-auto">
                <div class="cyber-card p-8 rounded-3xl">
                    <button onclick="openPage('menu-grid')" class="text-xs text-gray-500 mb-6">← BACK TO MENU</button>
                    <h2 class="text-xl font-bold mb-6 text-cyan-400 border-l-4 border-cyan-500 pl-3 uppercase">Registration</h2>
                    <div class="space-y-4">
                        <input type="text" id="u_name" placeholder="Client Name" class="glass-input">
                        <input type="number" id="u_num" placeholder="Mobile Number" class="glass-input">
                        <input type="text" id="u_addr" placeholder="Physical Address" class="glass-input">
                        <div class="grid grid-cols-2 gap-4">
                            <select id="u_dur" class="glass-input">
                                <option value="trial">3 Days Trial</option>
                                <option value="1month">1 Month</option>
                                <option value="1year">1 Year</option>
                                <option value="never">Never Expire</option>
                            </select>
                            <select id="u_pkg" class="glass-input">
                                <option value="pk150.m3u">150 Package</option>
                                <option value="pkmitv.m3u">200 Package</option>
                                <option value="mitv450.m3u">450 Package</option>
                            </select>
                        </div>
                        <input type="number" id="u_cash" placeholder="Payment Received (Rs)" class="glass-input">
                        <button onclick="executeRegistration()" id="regBtn" class="w-full bg-cyan-600 py-4 rounded-xl font-bold shadow-lg">ACTIVATE USER</button>
                    </div>
                </div>
            </section>

            <section id="manage-users-page" class="hidden">
                <button onclick="openPage('menu-grid')" class="text-xs text-gray-500 mb-6">← BACK TO MENU</button>
                <h2 class="text-xl font-bold mb-6">ACTIVE REDIRECTS</h2>
                <div id="redirect-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </section>

            <section id="m3u-editor-page" class="hidden">
                <div class="flex flex-wrap gap-4 mb-8 items-center bg-black/40 p-4 rounded-2xl border border-white/5">
                    <button onclick="openPage('menu-grid')" class="text-xs text-gray-500 mr-2">← BACK</button>
                    <select id="m3u-file-picker" onchange="fetchM3U()" class="glass-input md:w-64">
                        <option value="">-- SELECT PACKAGE ENGINE --</option>
                        <option value="pk150.m3u">150 Pkg</option>
                        <option value="pkmitv.m3u">200 Pkg</option>
                        <option value="mitv450.m3u">450 Pkg</option>
                    </select>
                    <button onclick="openAddChanModal()" class="bg-blue-600 px-6 py-2 rounded-lg font-bold text-xs uppercase">+ NEW CHANNEL</button>
                    <button onclick="saveM3UFinal()" class="bg-green-600 px-6 py-2 rounded-lg font-bold text-xs uppercase ml-auto">SAVE CHANGES</button>
                </div>

                <div id="m3u-folder-view" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>

                <div id="m3u-channel-view" class="hidden">
                    <div class="flex items-center gap-4 mb-6 border-b border-white/10 pb-4">
                        <button onclick="closeChannelView()" class="text-cyan-400 font-bold text-sm">← ALL GROUPS</button>
                        <h3 id="current-folder-title" class="text-lg font-bold uppercase tracking-widest text-white"></h3>
                    </div>
                    <div id="channel-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                </div>
            </section>

        </main>
    </div>

    <div id="chan-modal" class="fixed inset-0 bg-black/95 z-[2000] hidden flex items-center justify-center p-4">
        <div class="cyber-card p-8 rounded-3xl w-full max-w-md">
            <h3 id="modal-title" class="text-xl font-bold mb-6 text-cyan-400 uppercase">CHANNEL DETAILS</h3>
            <div class="space-y-4">
                <input type="text" id="n_name" placeholder="Channel Name" class="glass-input">
                <input type="text" id="n_logo" placeholder="Logo URL" class="glass-input">
                <input type="text" id="n_group" placeholder="Group Name" class="glass-input">
                <input type="text" id="n_link" placeholder="Stream Link" class="glass-input">
                <div class="flex gap-2">
                    <button onclick="confirmChannelAction()" class="flex-1 bg-cyan-600 py-3 rounded-xl font-bold uppercase" id="modal-submit-btn">Apply</button>
                    <button onclick="document.getElementById('chan-modal').classList.add('hidden')" class="flex-1 bg-gray-800 py-3 rounded-xl uppercase">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG - CHECK THESE CAREFULLY!
        const GITHUB_TOKEN = "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";
        const GITHUB_REPO = "muaaziqbalvip/Mitv";
        
        const USERS_DB = {
            "mu@@z1972": { name: "MiTV Professional", role: "admin" },
            "Abdulrehman12": { name: "Abdul Rehman", role: "reseller" }
        };

        let activeUser = null;
        let m3uData = [];
        let currentM3uSha = "";
        let editingIdx = null;

        function toB64(str) { return btoa(unescape(encodeURIComponent(str.trim()))); }
        function fromB64(str) { return decodeURIComponent(escape(atob(str))); }

        function checkLogin() {
            const val = document.getElementById('pass-input').value;
            if(USERS_DB[val]) {
                activeUser = USERS_DB[val];
                document.getElementById('lock-screen').classList.add('hidden');
                document.getElementById('dashboard-ui').classList.remove('hidden');
                document.getElementById('display-user').innerText = activeUser.name;
                if(activeUser.role === 'reseller') document.getElementById('admin-m3u-btn').classList.add('hidden');
                syncStats();
            } else {
                document.getElementById('err-msg').classList.remove('hidden');
            }
        }

        function openPage(id) {
            document.querySelectorAll('section, #menu-grid').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        async function ghApi(path, method = 'GET', body = null) {
            const opt = { 
                method, 
                headers: { 
                    'Authorization': `token ${GITHUB_TOKEN}`, 
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json' 
                } 
            };
            if(body) opt.body = JSON.stringify(body);
            const r = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${path}?nocache=${Date.now()}`, opt);
            if(!r.ok) {
                const err = await r.json();
                throw new Error(err.message || "API Error");
            }
            return await r.json();
        }

        async function syncStats() {
            try {
                const d = await ghApi('user.csv');
                const rows = fromB64(d.content).split('\n');
                let count = 0, total = 0;
                rows.forEach(r => {
                    const p = r.split(',');
                    if(p.length > 5 && (activeUser.role === 'admin' || p[5] === activeUser.name)) { count++; total += parseInt(p[4] || 0); }
                });
                document.getElementById('stat-count').innerText = count;
                document.getElementById('stat-cash').innerText = "Rs. " + total;
            } catch(e) { console.warn("Sync stats fail"); }
        }

        async function executeRegistration() {
            const data = {
                name: document.getElementById('u_name').value.trim().replace(/ /g, "_"),
                num: document.getElementById('u_num').value.trim(),
                dur: document.getElementById('u_dur').value,
                pkg: document.getElementById('u_pkg').value,
                cash: document.getElementById('u_cash').value || "0",
                addr: document.getElementById('u_addr').value || "N/A"
            };

            if(!data.name || !data.num) return alert("Error: Name and Mobile required!");
            const btn = document.getElementById('regBtn'); btn.innerText = "Syncing..."; btn.disabled = true;

            try {
                // 1. Update _redirects
                const red = await ghApi('_redirects');
                const redLines = fromB64(red.content);
                const newLine = `/${data.name}/${data.num}.m3u* https://mitvnetwork.netlify.app/${data.pkg} 200`;
                await ghApi('_redirects', 'PUT', { message: 'Add User', content: toB64(redLines + "\n" + newLine), sha: red.sha });

                // 2. Update user.csv
                const csv = await ghApi('user.csv');
                const csvLines = fromB64(csv.content);
                const newCsv = `${new Date().toLocaleDateString()},${data.name},${data.num},${data.dur},${data.cash},${activeUser.name},${data.addr}`;
                await ghApi('user.csv', 'PUT', { message: 'Add CSV', content: toB64(csvLines + "\n" + newCsv), sha: csv.sha });

                alert(`SUCCESS!\nLink: https://mitvnetwork.netlify.app/${data.name}/${data.num}.m3u`);
                location.reload();
            } catch(e) { 
                alert("GitHub Error: " + e.message); 
                btn.disabled = false; 
                btn.innerText = "ACTIVATE USER";
            }
        }

        async function loadRedirectList() {
            openPage('manage-users-page');
            try {
                const d = await ghApi('_redirects');
                const lines = fromB64(d.content).split('\n');
                const box = document.getElementById('redirect-list-container'); box.innerHTML = "";
                lines.forEach((line, idx) => {
                    if(!line.trim() || line.startsWith('#')) return;
                    const isOff = line.includes('out.m3u');
                    box.innerHTML += `<div class="cyber-card p-4 rounded-xl flex justify-between items-center">
                        <div>
                            <p class="text-xs font-bold text-white">${line.split(' ')[0]}</p>
                            <p class="text-[9px] ${isOff?'text-red-500':'text-green-500'} font-bold">${isOff?'DISABLED':'ACTIVE'}</p>
                        </div>
                        <button onclick="switchLinkStatus(${idx})" class="text-[10px] border border-white/20 px-4 py-1.5 rounded-lg">SWITCH</button>
                    </div>`;
                });
            } catch(e) { alert("List Error: " + e.message); }
        }

        async function switchLinkStatus(idx) {
            const d = await ghApi('_redirects');
            let lines = fromB64(d.content).split('\n');
            lines[idx] = lines[idx].includes('out.m3u') ? lines[idx].replace('out.m3u', '.m3u') : lines[idx].replace('.m3u', 'out.m3u');
            await ghApi('_redirects', 'PUT', { message: 'Toggle', content: toB64(lines.join('\n')), sha: d.sha });
            loadRedirectList();
        }

        async function fetchM3U() {
            const file = document.getElementById('m3u-file-picker').value;
            if(!file) return;
            try {
                const d = await ghApi(file);
                currentM3uSha = d.sha;
                m3uData = [];
                const lines = fromB64(d.content).split('\n');
                let temp = null;
                lines.forEach(l => {
                    if(l.includes('#EXTINF:')) {
                        const h = l.startsWith('##');
                        temp = { 
                            name: l.split(',')[1]?.trim() || "Unknown", 
                            logo: l.match(/tvg-logo="([^"]*)"/)?.[1] || "", 
                            group: l.match(/group-title="([^"]*)"/)?.[1] || "Others", 
                            link: "", hidden: h 
                        };
                        m3uData.push(temp);
                    } else if(l.startsWith('http') && temp) { temp.link = l.trim(); temp = null; }
                });
                renderM3UFolders();
            } catch(e) { alert("M3U Load Error: " + e.message); }
        }

        function renderM3UFolders() {
            const view = document.getElementById('m3u-folder-view'); view.innerHTML = "";
            document.getElementById('m3u-channel-view').classList.add('hidden'); view.classList.remove('hidden');
            const groups = [...new Set(m3uData.map(c => c.group))];
            groups.forEach(g => {
                const count = m3uData.filter(c => c.group === g).length;
                view.innerHTML += `<div onclick="openM3UFolder('${g}')" class="channel-tile p-6 text-center cursor-pointer">
                    <i class="fas fa-folder text-yellow-500 text-3xl mb-3"></i>
                    <h4 class="text-xs font-bold uppercase">${g}</h4><p class="text-[9px] text-gray-500">${count} CHANNELS</p>
                </div>`;
            });
        }

        function openM3UFolder(groupName) {
            document.getElementById('m3u-folder-view').classList.add('hidden');
            document.getElementById('m3u-channel-view').classList.remove('hidden');
            document.getElementById('current-folder-title').innerText = groupName;
            const grid = document.getElementById('channel-grid'); grid.innerHTML = "";
            m3uData.forEach((c, idx) => {
                if(c.group === groupName) {
                    grid.innerHTML += `<div class="channel-tile p-4 text-center ${c.hidden?'opacity-30':''}">
                        <img src="${c.logo}" class="w-12 h-12 mx-auto mb-2 object-contain rounded bg-black">
                        <h5 class="text-[10px] font-bold h-8 overflow-hidden">${c.name}</h5>
                        <div class="flex gap-1 mt-3">
                            <button onclick="toggleM3UChan(${idx}, '${groupName}')" class="flex-1 bg-white/5 text-[8px] py-1.5 rounded border border-white/10 uppercase">${c.hidden?'Show':'Hide'}</button>
                            <button onclick="editChanModal(${idx})" class="flex-1 bg-cyan-900/20 text-cyan-400 text-[8px] py-1.5 rounded border border-cyan-500/20 uppercase">Edit</button>
                        </div>
                    </div>`;
                }
            });
        }

        function toggleM3UChan(idx, g) { m3uData[idx].hidden = !m3uData[idx].hidden; openM3UFolder(g); }

        function openAddChanModal() {
            editingIdx = null;
            document.getElementById('modal-title').innerText = "Add Channel";
            document.getElementById('n_name').value = ""; document.getElementById('n_logo').value = "";
            document.getElementById('n_group').value = ""; document.getElementById('n_link').value = "";
            document.getElementById('chan-modal').classList.remove('hidden');
        }

        function editChanModal(idx) {
            editingIdx = idx;
            document.getElementById('modal-title').innerText = "Edit Channel";
            document.getElementById('n_name').value = m3uData[idx].name;
            document.getElementById('n_logo').value = m3uData[idx].logo;
            document.getElementById('n_group').value = m3uData[idx].group;
            document.getElementById('n_link').value = m3uData[idx].link;
            document.getElementById('chan-modal').classList.remove('hidden');
        }

        function confirmChannelAction() {
            const n = {
                name: document.getElementById('n_name').value,
                logo: document.getElementById('n_logo').value,
                group: document.getElementById('n_group').value || "Others",
                link: document.getElementById('n_link').value,
                hidden: editingIdx !== null ? m3uData[editingIdx].hidden : false
            };
            if(!n.name || !n.link) return alert("Error: Name and Stream Link are must!");
            if(editingIdx !== null) m3uData[editingIdx] = n;
            else m3uData.push(n);
            document.getElementById('chan-modal').classList.add('hidden');
            renderM3UFolders();
        }

        async function saveM3UFinal() {
            const file = document.getElementById('m3u-file-picker').value;
            let m3u = "#EXTM3U\n";
            m3uData.forEach(c => {
                const tag = c.hidden ? "##EXTINF:" : "#EXTINF:";
                m3u += `${tag}-1 tvg-logo="${c.logo}" group-title="${c.group}",${c.name}\n${c.link}\n`;
            });
            try {
                await ghApi(file, 'PUT', { message: 'Engine Update', content: toB64(m3u), sha: currentM3uSha });
                alert("SUCCESS: M3U Saved!");
                fetchM3U();
            } catch(e) { alert("GitHub Save Error: " + e.message); }
        }

        function closeChannelView() { renderM3UFolders(); }
    </script>
</body>
</html>
